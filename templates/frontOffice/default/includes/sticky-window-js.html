<script>
    {if $selectedSubCustomerId}
    //selectSubCustomer({$selectedSubCustomerId}, "{$subCustomerTitle}");
    {/if}

    {if $loginSubCustomerId}
    setSubCustomerLayout();
    {/if}

    const toggles = document.querySelectorAll("[data-toggle-cartManager]");

    if (toggles) {
        for (const toggle of toggles) {
            toggle.addEventListener("click", () => {
                document
                    .querySelector(".CartManagerPreview")
                    .classList.toggle("CartManagerPreview--visible");
            });
        }
    }

    $(".select_sub_order").on("click", function () {
        const subCustomerId = $(this).attr("data-id");

        selectSubCustomer(subCustomerId, $(this).text());
    });

    $("#group-order-home").on("click", function () {
        $("#group-order-cart-title").hide();
        $("#group-order-cart-body").hide();
        $("#group-order-main-body").show();
        $("#group-order-main-title").show();

        $.ajax('/module/groupOrder/goHome')
    });

    function selectSubCustomer(subCustomerId, title) {
        $("#group-order-main-title").hide();
        $("#group-order-main-body").hide();
        $("#group-order-cart-title").show();
        $("#group-order-cart-body").show();
        if (title) {
            $("#sub-customer-name").text(title);
        }

        $.getJSON('/module/groupOrder/getSubCustomerCart', {
            sub_customer_id: subCustomerId
        }).done(function (json) {
            const userCart = $("#CartManagerPreview-user" + subCustomerId + "-cart");

            userCart.empty();
            json.cartItems.forEach(function (cartItem) {
                userCart.append(
                    "<div class='col-12'><div class='row'>" +
                    "<div class='col-7'>" + cartItem.title + "<br><strong>" + cartItem.format + "</strong></div>" +
                    "<div class='col-2'>" + cartItem.price + "</div>" +
                    "<div class='col-1'> x" + cartItem.quantity + "</div>" +
                    "<div class='col-2'>" + cartItem.total + "</div>" +
                    "</div></div>"
                );
            });
            if (json.cartItems.length === 0) {
                userCart.append(
                    "<tr><td>" +
                    "<div>" + "{intl l="Empty" d="grouporder.fo.default"}" + "</div>" +
                    "</td></tr>"
                );
            }
        })
    }

    function setSubCustomerLayout() {
        $(".register").parent().hide();
        const login = $(".login").parent();

        $(
            '<div class="Toolbar-item navbar-customer">' +
            '<a href="{url path="/logout/sub-customer"}" class="account has-separator">' +
            '<span class="Toolbar-itemWrapIcon"><svg class="Toolbar-itemIcon perso"><use xlink:href="/front/assets/dist/svg/sprite.svg#perso"></use></svg></span>' +
            '<span class="Toolbar-itemText">Deconnexion</span>' +
            ' </a>' +
            ' </div>'
        ).insertAfter(login);
        login.hide();


        $('.table-cart tbody tr:last').hide();
        $('.table-cart tr:last').prev().hide();

        const cartNext = $('#cart').find("> .btn-primary");
        $('<a href="{url path="/cart/sub-customer"}" class="btn btn-primary pull-right">{intl l="Validate Cart" d="grouporder.fo.default"}</a>').insertAfter(cartNext);
        cartNext.hide();
    }
</script>